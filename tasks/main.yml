---
- name: install postgresql repository
  yum:
      name: "{{ PG_PACKAGE_RPM }}"

- name: install postgresql package
  yum:
      name:
          - "{{ PG_PACKAGE_BASE }}-server"
          - "{{ PG_PACKAGE_BASE }}-devel"
          - "{{ PG_PACKAGE_BASE }}-contrib"
  tags: postgresql

- name: detect postgresql version file
  stat:
      path: "/var/lib/pgsql/{{ PG_VERSION }}/data/PG_VERSION"
  register: dbcluster
  tags: postgresql

- name: setup postgresql
  command: "/usr/pgsql-{{ PG_VERSION }}/bin/{{ PG_PACKAGE_BASE }}-setup initdb"
  when: not dbcluster.stat.exists
  tags: postgresql

- name: copy postgresql conf
  template:
      src: postgresql.conf.j2
      dest: "/var/lib/pgsql/{{ PG_VERSION }}/data/postgresql.conf"
      mode: 0600
  notify: restart postgresql service
  tags: postgresql

- name: start postgresql service
  service:
      name: "postgresql-{{ PG_VERSION }}"
      state: started
      enabled: yes
  tags: postgresql
